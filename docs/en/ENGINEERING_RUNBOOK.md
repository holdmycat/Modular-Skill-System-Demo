# Engineering Runbook

**Purpose**: The "Operating Manual" for the core architecture of this project.
**Audience**: Daily development, onboarding, and emergency troubleshooting.
**Principle**: Action first, Context second.

---

## ðŸ”´ Quick Actions

| Scenario | Action | Detailed Doc |
| :--- | :--- | :--- |
| **I added a new data class, but it won't load** | Add `[BsonDeserializerRegister]` attribute to the class, then press `Ctrl+S`. | [Bson AOT Guide](bson_aot_maintenance_guide.md) |
| **I need to add a new character attribute (e.g., Armor)** | **NEVER** edit `eNumericType` directly! Add the field to `AttributeSchema.json` and run the generation menu. | [Magic Number Analysis](magic_number_fragility_lesson.md) |
| **Mobile build crashes on startup / AOT error** | Check if `RoslynAnalyzers` compiled correctly. Re-run `./build_bson_generator.sh`. | [Bson AOT Guide](bson_aot_maintenance_guide.md) |

---

## 1. Data Serialization System (BSON AOT)

### ðŸŸ¢ Daily Dev: Adding New Data Types
When creating new `SkillData`, `BuffData`, or `ItemData`:

1.  **Action**: Add `[BsonDeserializerRegister]` above the class definition.
    ```csharp
    [BsonDeserializerRegister] // <--- MUST ADD THIS!
    public class MyNewData : NodeDataBase { ... }
    ```
2.  **Verify**: Save the code. Unity will compile, and the type is automatically registered.
3.  **Forbidden**: Do not manually edit `GeneratedTypeRegistry.cs`. It is machine-generated.

### ðŸŸ¡ Maintenance: Modifying the Generator
If you need to change the generated code format or support new features:

1.  **Modify**: Edit `RoslynAnalyzers/BsonMapGenerator.cs`.
2.  **Build**: Run the build script in the terminal.
    ```bash
    cd RoslynAnalyzers
    ./build_bson_generator.sh
    ```
3.  **Apply**: Switch back to Unity and wait for compilation.

---

## 2. Numeric Attribute System (Attribute Schema)

### ðŸŸ¢ Daily Dev: Adding/Modifying Attributes
When you need a new attribute (e.g., `CriticalChance`):

1.  **Action**: Open `Assets/Config/AttributeSchema.json` (example path).
2.  **Edit**:
    ```json
    {
      "Name": "CriticalChance",
      "HasBase": true,   // Needs base value
      "HasAdd": true,    // Needs equipment bonus
      "HasMult": false   // No percentage multiplier needed
    }
    ```
3.  **Generate**: Click Unity Menu `Tools -> Generate Numeric Types`.
4.  **Result**: `eNumericType.cs` updates automatically with new IDs.

### ðŸ”´ Red Alert: Strictly Forbidden
*   âŒ **FORBIDDEN**: Manually editing `eNumericType.cs`. Your changes will be overwritten.
*   âŒ **FORBIDDEN**: Hardcoding `(int)type * 10 + 1` logic. Use helper functions like `AttributeUtils.GetBaseType(type)`.

---

## 3. Troubleshooting

### Q: "Duplicate Definition" Error
*   **Cause**: Old manual generator file (`TypeRegistryGenerator.cs`) was not deleted.
*   **Fix**: Search for `GeneratedTypeRegistry` and delete the physical file in the Assets folder. Keep only the one generated by `RoslynAnalyzers`.

### Q: Attribute IDs are wrong / Values are incorrect
*   **Cause**: Someone bypassed the Schema and edited the Enum, or Schema conflict during merge.
*   **Fix**:
    1.  Revert `eNumericType.cs`.
    2.  Resolve Git conflict in `AttributeSchema.json`.
    3.  Re-run `Generate Numeric Types`.

---

> **Architect's Note**:
> Human memory is unreliable. Processes and tools are reliable.
> Check this runbook before "hacking" the code.
